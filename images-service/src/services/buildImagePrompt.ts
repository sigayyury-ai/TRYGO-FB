interface IdeaInput {
  title: string;
  description?: string | null;
  category?: string | null;
}

export type ImageVariant = "hero" | "inline";

export interface ImagePrompt {
  prompt: string;
  negativePrompt: string;
  style: string;
  aspectRatio: string;
}

const sanitize = (value: string | undefined | null): string =>
  (value ?? "").replace(/\s+/g, " ").trim();

const truncate = (value: string, max = 200): string =>
  value.length > max ? `${value.slice(0, max - 1).trim()}…` : value;

const sample = <T>(items: T[]): T =>
  items[Math.floor(Math.random() * items.length)] ?? items[0];

const framingOptions: Record<ImageVariant, string[]> = {
  hero: [
    "Сфокусируй композицию как на кинематографичном широком кадре с выраженным передним планом.",
    "Сними сцену как establishing-shot: глубокая перспектива, крупные планы деталей на переднем плане и открытое пространство позади.",
    "Используй широкоугольную перспективу, чтобы подчеркнуть масштаб, слои окружения и драматичный свет."
  ],
  inline: [
    "Сделай более тесную композицию, акцентируя ключевые детали на среднем плане.",
    "Сфокусируйся на главном объекте, оставляя фон мягко размытым и поддерживающим идею.",
    "Построй кадр как репортажный: зритель находится рядом с действием, детали читаются сразу."
  ]
};

const moodHints = [
  "Передай настроение через выразительный свет: подчеркни переходы света и тени, чтобы сцена выглядела живой.",
  "Добавь ощущение энергии с помощью диагональных линий, ритма и лёгкого движения в кадре.",
  "Создай спокойную атмосферу благодаря мягкому рассеянному освещению и плавным градиентам.",
  "Пусть свет и цвет отражают эмоцию темы: подчеркни контраст между тёплыми и холодными зонами."
];

const detailHints = [
  "Обязательно покажи характерные мелкие детали и фактуры, чтобы зритель почувствовал реальность происходящего.",
  "Детализируй материалы (металл, стекло, ткань) и добавь следы использования, чтобы всё выглядело правдоподобно.",
  "Включи в сцену бытовые мелочи или инструменты, которые поддерживают нарратив и раскрывают контекст."
];

const paletteHints = [
  "Подбери палитру с натуральными базовыми тонами и ярким акцентом, который ведёт взгляд.",
  "Комбинируй холодные оттенки синего/бирюзы с тёплыми вспышками янтаря или меди.",
  "Используй приглушённые землистые цвета и добавь насыщенные акценты для глубины.",
  "Сыграй на контрасте неоновых оттенков и мягкого естественного фона."
];

const cameraHints = [
  "Используй умеренную глубину резкости: главный объект чёткий, фон мягко читаемый.",
  "Добавь лёгкий широкий угол, чтобы подчеркнуть перспективу и включить больше окружения.",
  "Сделай кадр статичным, но с намёком на движение (лёгкое размытие / позы людей).",
  "Продумай траекторию взгляда: от переднего плана к главному событию и далее в фон."
];

const styleVariants = [
  {
    name: "realistic photography",
    instruction:
      "Стиль изображения: реалистичное фото, живое и натуральное; четкие, естественные цвета; предметы с настоящими текстурами; продуманная композиция (передний, средний, задний планы); никакого глянцевого журнального вида."
  },
  {
    name: "cinematic realism",
    instruction:
      "Стиль изображения: кинематографичный реализм с контролируемым светом, мягкими переходами, атмосферной дымкой и аккуратными бликами на ключевых объектах."
  },
  {
    name: "documentary photo",
    instruction:
      "Стиль изображения: честная документальная фотография без постановочной глянцевости; естественный свет, текстуры реальной среды, легкая зернистость допустима."
  }
];

export function buildImagePrompt(idea: IdeaInput, variant: ImageVariant): ImagePrompt {
  const title = sanitize(idea.title) || "Untitled concept";
  const summary =
    truncate(
      sanitize(idea.description) ||
        `Опиши ключевые аспекты темы "${title}"`,
      220
    );

  const framing = sample(framingOptions[variant]);
  const styleDirection = sample(styleVariants);
  const variationHints = [sample(moodHints), sample(detailHints), sample(paletteHints), sample(cameraHints)].join(" ");

  const prompt = [
    `Создай реалистичное, детализированное изображение по следующей теме: "${title}".`,
    `Используй описание: "${summary}" как основу для построения сцены.`,
    "Сформируй цельный визуальный кадр, включающий главный объект или действие, подходящее окружение, предметы, важные для раскрытия идеи, и при необходимости действия людей или объектов.",
    "Передай назначение сцены и её эмоции: подчеркни смысл, процесс или символику происходящего.",
    styleDirection.instruction,
    variationHints,
    "Жёсткие исключения: никаких текстовых блоков, надписей,; никаких логотипов, мемов, инфографики, UI-элементов или водяных знаков. Изображение должно быть полностью свободно от текстовой информации.",
    framing
  ].join(" ");

  const aspectRatio = variant === "hero" ? "16:9" : "4:3";

  return {
    prompt,
    negativePrompt:
      "text, letters, words, numbers, captions, typography, logos, ui elements, watermarks, memes, infographics, low quality, noisy texture, overexposed lighting, unrealistic anatomy, plastic skin",
    style: styleDirection.name,
    aspectRatio
  };
}


