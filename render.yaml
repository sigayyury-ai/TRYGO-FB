# ============================================
# TRYGO Platform - Render Deployment Configuration
# ОПТИМИЗИРОВАННАЯ ВЕРСИЯ - ЕДИНЫЙ API GATEWAY
# ============================================
# 
# АРХИТЕКТУРА:
# - trygo-main-backend: Единый API Gateway ($7/месяц) - все запросы идут через него
#   Включает: авторизацию, проекты, гипотезы, SEO Agent, Images API, Clusters API, Website Pages API (все интегрировано)
# - trygo-frontend: БЕСПЛАТНО (static site)
#
# ИТОГО: $7/месяц (images-service, semantics-service, SEO Agent backend, website-pages-service интегрированы в trygo-main-backend)
#
# Для деплоя:
# 1. Подключите репозиторий в Render Dashboard
# 2. Выберите "New Blueprint" и укажите этот файл
# 3. Установите все переменные окружения с sync: false
# 4. После деплоя trygo-main-backend, обновите VITE_SERVER_URL, VITE_SEO_AGENT_URL и VITE_WS_SERVER_URL
#    в trygo-frontend на реальные URL из Render Dashboard
#
# Подробная инструкция: см. DEPLOY_RENDER.md
# ============================================

services:
  # ============================================
  # Main Backend (TRYGO-Backend) - ЕДИНЫЙ API GATEWAY
  # Объединяет: авторизацию, проекты, гипотезы, SEO Agent, Images API, Clusters API, Website Pages API
  # ============================================
  - type: web
    name: trygo-main-backend
    runtime: node
    region: frankfurt
    plan: starter
    rootDir: TRYGO-Backend
    buildCommand: npm ci --include=dev && npm run codegen && npm run build
    startCommand: npm start
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      # Явно указываем версию Node.js для совместимости
      - key: NODE_VERSION
        value: "20"
      - key: MONGODB_URI
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_STARTER_MONTHLY_PRICE_ID
        sync: false
      - key: STRIPE_PRO_MONTHLY_PRICE_ID
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: FRONTEND_URL
        fromService:
          type: web
          name: trygo-frontend
          property: host
      - key: DEVELOPMENT_FRONTEND_URL
        fromService:
          type: web
          name: trygo-frontend
          property: host
      - key: PRODUCTION_FRONTEND_URL
        fromService:
          type: web
          name: trygo-frontend
          property: host
      - key: CORS_ENABLED
        value: "true"
      - key: GOOGLE_AUTH_CLIENT_ID
        sync: false
      - key: GOOGLE_AUTH_CLIENT_SECRET
        sync: false
      # AWS и Telegram отключены - не нужны пока
      # - key: AWS_ACCESS_KEY
      # - key: AWS_SECRET_ACCESS_KEY
      # - key: AWS_REGION
      # - key: AWS_BUCKET_NAME
      # - key: MAILT_API_KEY
      # - key: MAILT_EMAIL_ADDRESS
      # - key: MAILT_FROM_NAME
      # - key: BOUNCER_CHECK_API_KEY
      # - key: TG_CHAT_ID_STATISTICS
      # - key: TG_CHAT_ID_ERROR
      # - key: TG_TOKEN_STATISTICS
      # - key: TG_ENABLED
      # SEO Agent integrated - no separate backend service needed
      # Semantics service integrated - clusters API available at /api/clusters
      - key: IMAGES_SERVICE_URL
        sync: false
      # WEBSITE_PAGES_SERVICE_URL removed - service integrated into TRYGO-Backend
      - key: WORDPRESS_BASE_URL
        sync: false
      - key: WORDPRESS_USERNAME
        sync: false
      - key: WORDPRESS_APP_PASSWORD
        sync: false
      # Image generation configuration (integrated into TRYGO-Backend)
      # Uses Google Gemini/Imagen for image generation
      - key: IMAGE_PROVIDER
        value: gemini
      - key: GEMINI_API_KEY
        sync: false
      - key: GOOGLE_API_KEY
        sync: false
      - key: GEMINI_IMAGE_MODEL
        value: imagen-4.0-generate-001
      - key: GEMINI_API_BASE_URL
        value: https://generativelanguage.googleapis.com/v1beta
      # PUBLIC_URL будет автоматически установлен Render (URL сервиса trygo-main-backend)
      # Используется для доступа к статическим файлам (/media)
      - key: PUBLIC_URL
        fromService:
          type: web
          name: trygo-main-backend
          property: host
      - key: STORAGE_ROOT
        value: ./storage

  # ============================================
  # Frontend (React SPA)
  # Статический сайт (БЕСПЛАТНО на Render)
  # ============================================
  - type: web
    name: trygo-frontend
    runtime: static
    rootDir: TRYGO-Front
    buildCommand: npm ci && npm run build
    staticPublishPath: ./dist
    envVars:
      - key: NODE_VERSION
        value: "20"
    envVars:
      # ВАЖНО: После деплоя trygo-main-backend, обновите эти URL вручную в Render Dashboard
      # Замените <trygo-main-backend-url> на реальный URL (например: https://trygo-main-backend.onrender.com)
      - key: VITE_SERVER_URL
        value: https://trygo-main-backend.onrender.com/graphql
      - key: VITE_SEO_AGENT_URL
        value: https://trygo-main-backend.onrender.com/graphql
      - key: VITE_WS_SERVER_URL
        value: wss://trygo-main-backend.onrender.com
      - key: VITE_GOOGLE_CLIENT_ID
        sync: false
      - key: VITE_SEO_AGENT_ENABLED
        value: "true"
      - key: VITE_SEO_AGENT_DEV_SHELL
        value: "false"
      - key: VITE_SEO_AGENT_UI_TESTING
        value: "false"

  # ============================================
  # Website Pages Service - ИНТЕГРИРОВАН в trygo-main-backend
  # Website Pages API доступен через /api/website-pages/generate в trygo-main-backend
  # Отдельный сервис больше не нужен
  # ============================================

  # ============================================
  # Semantics Service - ИНТЕГРИРОВАН в trygo-main-backend
  # Clusters API доступен через /api/clusters в trygo-main-backend
  # Отдельный сервис больше не нужен
  # ============================================

