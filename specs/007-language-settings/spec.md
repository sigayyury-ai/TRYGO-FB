# Feature Specification: Language Settings

**Feature Branch**: `007-language-settings`  
**Created**: 2025-11-13  
**Status**: Draft  
**Input**: User description: "У нас в настройках должна быть возможность выбора языка генерации, по умолчанию подтягиваем язык проекта, но пользователь может его изменить."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - View Auto-Detected Language (Priority: P1)

As a strategist, I want to open the settings panel and immediately see which language the system will use for draft generation so I can confirm it matches the project context.

**Why this priority**: Without a trustworthy default, стратеги получают драфты на неверном языке, что блокирует работу.

**Independent Test**: Load settings for a project with language metadata → verify UI shows the detected language, explains источник автоопределения, и не требует ручного выбора.

**Acceptance Scenarios**:

1. **Given** a project with language configured (e.g., `ru-RU`), **When** the strategist открывает настройки, **Then** система отображает язык “Russian (ru-RU)” и помечает его как “автоопределён из проекта”.
2. **Given** автоопределение не удаётся (нет данных в проекте/ICP), **When** пользователь открывает настройки, **Then** показывается fallback “English (en-US)” и блок с предупреждением/ TODO.
3. **Given** проект сменил основной язык, **When** настройки открываются снова, **Then** автоопределённое значение обновлено без ручного вмешательства.

---

### User Story 2 - Override Language for Content Generation (Priority: P1)

As a strategist, I want to вручную выбрать язык для генерации драфтов, чтобы адаптировать контент под конкретную целевую аудиторию или рынок.

**Why this priority**: Иногда требуется локализация отличная от базового проекта; отсутствие гибкости приводит к дополнительным перекладкам.

**Independent Test**: Выбрать язык “Spanish (es-ES)” → сохранить → сгенерировать драфт → убедиться, что backend использует выбранный язык.

**Acceptance Scenarios**:

1. **Given** пользователь выбирает новый язык и сохраняет, **When** создаётся новый драфт, **Then** AI получает этот язык в prompt и возвращает текст на нём.
2. **Given** выбран язык, **When** пользователь возвращается к настройкам, **Then** значение отображается как “пользовательский выбор”, есть опция “сбросить на язык проекта”.
3. **Given** пользователь сбрасывает язык, **When** сохраняет изменения, **Then** генерация снова использует автоопределённый проектный язык.

---

### User Story 3 - Persist & Audit Language Changes (Priority: P2)

As an operations lead, I need изменения языка логировать и хранить вместе с пользователем/временем, чтобы отслеживать, почему конкретные драфты появились на ином языке.

**Why this priority**: Позволяет избежать непредвиденных локализаций и помогает при расследовании инцидентов.

**Independent Test**: Сменить язык → проверить журнал/историю → убедиться, что запись содержит projectId, userId, старое/новое значение.

**Acceptance Scenarios**:

1. **Given** язык переключён, **When** экспортируется журнал или запрашивается API истории, **Then** запись содержит userId, timestamp, fromLanguage, toLanguage, источник.
2. **Given** языки переключаются быстро несколько раз, **When** просматривается история, **Then** все изменения отображены в хронологическом порядке.
3. **Given** необходимо восстановить дефолт, **When** администратор включает “force project language”, **Then** UI показывает блокировку override и логируется событие “locked by admin”.

---

### Edge Cases

- Автоопределение языка не удаётся — показываем fallback + рекомендации заполнить данные в проекте.
- Пользователь выбирает язык, который не поддерживается AI-моделью — показываем предупреждение и не даём сохранить.
- Несколько пользователей одновременно меняют язык — последняя сохранённая настройка применяется, но в истории фиксируются все попытки.
- Проект меняет язык, пока пользователь держит открытой страницу настроек —提示 о том, что доступно новое авто значение.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Настройки должны отображать автоопределённый язык на основе project.language / ICP / Lean Canvas полей.
- **FR-002**: Пользователь может выбрать язык из поддерживаемого списка (ISO code + локализованное название).
- **FR-003**: Система должна валидировать выбор языка (сопоставить со списком поддерживаемых AI-моделей).
- **FR-004**: Пользователь может сбросить настройки к значению проекта одной кнопкой.
- **FR-005**: При сохранении override значения сохраняются в базе и используются всеми генераторами драфтов/идей.
- **FR-006**: Изменение языка должно логироваться вместе с userId, projectId, timestamp и источником (auto / manual).
- **FR-007**: API настроек возвращает как автоопределённое значение, так и текущее пользовательское (если есть).
- **FR-008**: UI отображает предупреждение, если выбранный язык отличается от языка проекта.
- **FR-009**: При отсутствии данных система подсвечивает TODOs (например, “заполните ICP language”).
- **FR-010**: Реализовать feature flag `LANGUAGE_SETTINGS_ENABLED` для поэтапного включения.

### Key Entities *(include if feature involves data)*

- **LanguageSetting**: хранит projectId, hypothesisId (опционально), detectedLanguage, manualLanguage, updatedBy, updatedAt, source.
- **LanguageAuditLog**: записи об изменениях языка, содержит fromLanguage, toLanguage, userId, timestamp, source (“auto-detect”, “manual override”).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 95% новых драфтов генерируются на ожидаемом языке (сверяется по выборке QA) в течение первых двух недель после релиза.
- **SC-002**: В 90% проектов пользователи не меняют язык вручную — свидетельство корректного автоопределения.
- **SC-003**: 100% изменений языка отражаются в аудит-логе в течение ≤5 секунд.
- **SC-004**: Пользователи оценивают настройку ≥4.0/5 по опросу удобства через неделю после релиза.
- **SC-005**: Ноль критических инцидентов, связанных с неправильной локализацией, в течение первого месяца.
