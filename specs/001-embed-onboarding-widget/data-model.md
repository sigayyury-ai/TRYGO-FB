# Data Model: Embeddable Onboarding Widget

**Feature**: Embeddable Onboarding Widget  
**Date**: 2025-01-27  
**Phase**: 1 - Design & Contracts

## Entities

### EmbeddedOnboardingSubmission

Represents a form submission from the embedded onboarding widget.

**Fields**:
- `email` (String, required): User's email address
- `startType` (Enum, required): Project start type - `START_FROM_SCRATCH` or `URL_IMPORT`
- `info` (String, required): Project description (minimum 10 characters)
- `url` (String, optional): Website URL (required when `startType` is `URL_IMPORT`)
- `embedSource` (String, optional): Origin/URL of the page where widget is embedded (for tracking)
- `userAgent` (String, optional): User agent string (for analytics)

**Validation Rules**:
- Email must be valid format (reuse existing email validation)
- `info` must be at least 10 characters (same as existing onboarding)
- `url` must be valid URL format when `startType` is `URL_IMPORT`
- `url` must be empty/null when `startType` is `START_FROM_SCRATCH`

**State Transitions**:
1. **Submitted** → System checks if email exists
2. **Email Exists** → Check subscription limits → Create project OR Return error
3. **Email New** → Create account → Generate password → Send email → Create project → Trigger generation

**Relationships**:
- Links to `User` entity (via email)
- Creates `Project` entity
- May create `AutoGeneratedAccount` (if new user)

---

### AutoGeneratedAccount

Represents a user account created automatically through the embedded widget.

**Fields**:
- `email` (String, required): User's email address
- `passwordHash` (String, required): Hashed password (using bcrypt, same as manual registration)
- `generatedPassword` (String, transient): Plain text password (only exists during creation, sent via email, never stored)
- `role` (Enum, required): User role - defaults to `USER`
- `freeTrialDueTo` (Date, required): Free trial expiration (7 days from creation)
- `source` (String, optional): Track that account was created via "embedded_widget"
- `createdAt` (Date, auto): Account creation timestamp

**Validation Rules**:
- Email must be unique (enforced by existing User model)
- Password must be cryptographically secure (generated, not user-provided)
- Password hash must use same bcrypt configuration as manual registration (SALT_ROUNDS: 5)

**State Transitions**:
1. **Created** → Password generated → Password hashed → Account saved → Password emailed
2. **Password Sent** → Account is active, user can log in

**Relationships**:
- Extends existing `User` model (same collection, additional metadata)
- Creates `Project` entity after account creation

---

### EmbeddedOnboardingResponse

Response returned after processing embedded onboarding submission.

**Fields**:
- `success` (Boolean, required): Whether submission was successful
- `userId` (String, optional): User ID (if account was created or existing user found)
- `projectId` (String, optional): Project ID (if project was created)
- `isNewAccount` (Boolean, required): Whether a new account was created
- `passwordSent` (Boolean, required): Whether password email was sent (only true for new accounts)
- `errorCode` (String, optional): Error code if submission failed
- `errorMessage` (String, optional): Human-readable error message
- `subscriptionLimitReached` (Boolean, optional): Whether existing user has reached project limit

**Validation Rules**:
- `success` must be false if `errorCode` or `errorMessage` is present
- `passwordSent` must be false if `isNewAccount` is false
- `projectId` must be present if `success` is true and subscription limit not reached

**State Transitions**:
- **Success Path**: `success: true`, `projectId` present, `passwordSent` based on `isNewAccount`
- **Error Path**: `success: false`, `errorCode` and `errorMessage` present
- **Limit Reached Path**: `success: false`, `subscriptionLimitReached: true`, `errorMessage` explains limit

---

## Data Flow

### New User Flow

```
EmbeddedOnboardingSubmission
  ↓
Check email existence → Not found
  ↓
Generate secure password
  ↓
Create User (with passwordHash)
  ↓
Send password email
  ↓
Check subscription limits (new user = FREE plan, 1 project allowed)
  ↓
Create Project
  ↓
Trigger project generation
  ↓
Return EmbeddedOnboardingResponse (success: true, isNewAccount: true, passwordSent: true)
```

### Existing User Flow (Limit Available)

```
EmbeddedOnboardingSubmission
  ↓
Check email existence → Found
  ↓
Get user subscription
  ↓
Check project count vs. subscription limits
  ↓
Limit allows → Create Project
  ↓
Trigger project generation
  ↓
Return EmbeddedOnboardingResponse (success: true, isNewAccount: false, passwordSent: false)
```

### Existing User Flow (Limit Reached)

```
EmbeddedOnboardingSubmission
  ↓
Check email existence → Found
  ↓
Get user subscription
  ↓
Check project count vs. subscription limits
  ↓
Limit reached → Return error
  ↓
Return EmbeddedOnboardingResponse (success: false, subscriptionLimitReached: true, errorMessage: "You have reached the maximum number of projects...")
```

## Database Schema

### User Collection (Existing - Extended)

The existing `User` model is reused. No schema changes required, but we may add optional metadata:

- `source` (String, optional): Track account creation source (e.g., "embedded_widget", "manual", "google_oauth")

### Project Collection (Existing - Reused)

No changes to Project model. Projects created via embedded widget are identical to manually created projects.

## Validation Rules Summary

### Email Validation
- Format: Standard email regex (reuse existing validation)
- Uniqueness: Enforced by User model (existing constraint)

### Project Description Validation
- Minimum length: 10 characters (same as existing onboarding)
- Maximum length: [NEEDS CLARIFICATION: Check existing limit]

### URL Validation (when importing)
- Format: Must be valid HTTP/HTTPS URL
- Pattern: `^https?://.+\..+` (same as existing onboarding validation)

### Password Generation
- Length: 16 characters (configurable)
- Character set: A-Z, a-z, 0-9, optionally special characters
- Security: Cryptographically secure (crypto.randomBytes)

## Edge Cases Handled

1. **Duplicate Email**: Check before creation, use existing account
2. **Invalid Email Format**: Validate before processing, return error
3. **Subscription Limit Reached**: Check before project creation, return clear error
4. **Network Failure During Email Send**: Log error, account still created, user can use password reset
5. **Project Generation Failure**: Account created, project created, but generation fails - return partial success with error message
6. **Concurrent Submissions**: Database constraints prevent duplicate accounts, idempotency handled by email uniqueness
